<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Configuration Sources - Autostrap Documentation</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Configuration Sources";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Autostrap Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Introduction</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../components/">Components</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../entry/">Entry Points</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../lifecycle/">Life of a Stack</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 current">
        <a class="current" href="./">Configuration Sources</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#configuration-sources">Configuration Sources</a></li>
                
                    <li><a class="toctree-l4" href="#global-config-default-configuration">global-config: Default Configuration</a></li>
                
                    <li><a class="toctree-l4" href="#project-configuration">Project Configuration</a></li>
                
                    <li><a class="toctree-l4" href="#additional-configuration">Additional Configuration</a></li>
                
                    <li><a class="toctree-l4" href="#cloud-init-user-data-script-and-metadata-parameters">cloud-init: User Data Script and Metadata Parameters</a></li>
                
                    <li><a class="toctree-l4" href="#cloud-init-metadata-parameters">cloud-init metadata parameters</a></li>
                
            
            </ul>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../workflow/">Deployment Workflow</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../howto/">How do I...</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../topics/">Configuration Topic Reference</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../glossary/">Glossary</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Autostrap Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Configuration Sources</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <div class="toc">
<ul>
<li><a href="#configuration-sources">Configuration Sources</a><ul>
<li><a href="#global-config-default-configuration">global-config: Default Configuration</a></li>
<li><a href="#project-configuration">Project Configuration</a></li>
<li><a href="#additional-configuration">Additional Configuration</a><ul>
<li><a href="#additional_config-parameter-format">additional_config Parameter Format</a></li>
<li><a href="#additional_config-example">additional_config Example</a></li>
<li><a href="#entry-position-in-hierayaml">Entry Position in hiera.yaml</a></li>
</ul>
</li>
<li><a href="#cloud-init-user-data-script-and-metadata-parameters">cloud-init: User Data Script and Metadata Parameters</a><ul>
<li><a href="#cloud-init-user-data-script">cloud-init user-data script</a></li>
</ul>
</li>
<li><a href="#cloud-init-metadata-parameters">cloud-init metadata parameters</a></li>
</ul>
</li>
</ul>
</div>
<p><img alt="Overview of Autostrap configuration sources" src="./overview.svg" /></p>
<p>Machines deployed through Autostrap draw their configuration from various
sources. The schematic above shows a big-picture view of these sources and how
they interact with each other. In this section we will discuss the four sources
for configuration information Autostrap uses: </p>
<ul>
<li>Default configuration from <a href="https://github.com/autostrap/global-config">global-config</a></li>
<li>project specific configuration from a <a href="../config/#project">project-config</a>
  repository</li>
<li>Additional user specified configuration repositories</li>
<li><a href="https://cloudinit.readthedocs.org/">cloud-init</a> user-data and metadata.</li>
</ul>
<p>Read this section to get an in-depth tour of the configuration sources at your
disposal. If you are itching to try Autostrap you can skip this section. Just
create a private fork of <a href="https://github.com/autostrap/project-config">project-config</a> and
move on to the <a href="../workflow">Deployment Workflow</a> section.</p>
<h1 id="configuration-sources">Configuration Sources</h1>
<p><a name='global'></a></p>
<h2 id="global-config-default-configuration">global-config: Default Configuration</h2>
<p>The repository <a href="https://github.com/autostrap/global-config">global-config</a> contains
collections of Puppet classes along with matching
<a href="http://docs.puppetlabs.com/hiera/1/">Hiera</a> configuration to deploy on Openstack
instances. We refer to these collections as <a href="../glossary/#topic">topics</a>). Topics can
be deployed to instances in two ways: directly, using the <code>topics</code>
metadata parameter, or indirectly by
<a href="../workflow/#master-agent-topics">integrating</a> them in a
<a href="../glossary/#project-config">project-config</a> repository.</p>
<p>The <code>global-config</code> repository is meant as default configuration, to be overriden and extended
by the <a href="../glossary/#project-config">project-config</a> repository described in the next
section.</p>
<p><a name='project'></a></p>
<h2 id="project-configuration">Project Configuration</h2>
<p>The second pilar of configuration is the <a href="../glossary/#project-config">project-config</a> repository. 
This is where a Autostrap user will store most of their configuration. Since a
fair amount of configuration is provided by global-config, this repository's
configuration payload can be fairly small. For instance, the [project
configuration content][ex::docserver] required to set up a web server building and serving this
documentation consists of 69 lines at the time of this writing.</p>
<p>Usually a <code>project-config</code> repository starts out as a fork of Autostrap's
<a href="https://github.com/autostrap/project-config">example project-config repository</a>. We
recommend you store this fork in a private Git repository which is accessible
with an SSH deploy key provided to machines using the <code>deploy_key</code> parameter of
the <a href="http://autostrap.github.io/heat-resources/#_as_autostrap">AS::autostrap Heat resource</a>.
The <code>project-config</code> repository's URL and revision are specified
through the <a href="http://autostrap.github.io/heat-resources/#_config_repo"><code>config_repo</code></a>
and <a href="http://autostrap.github.io/heat-resources/#_config_branch"><code>config_branch</code></a>
parameters to the
<a href="http://autostrap.github.io/heat-resources/#_as_autostrap">AS::autostrap Heat resource</a>, respectively.</p>
<p><a name='additional'></a></p>
<h2 id="additional-configuration">Additional Configuration</h2>
<p>Finally, autostrap contains a mechanism for inserting arbitrary snippets of
Hiera configuration. This mechanism is controlled through the
<a href="http://autostrap.github.io/heat-resources/#_additional_config">AS::autostrap Heat resource's <code>additional_config</code> parameter</a>
which contains a space delimited list of git repositories. These repositories
are cloned during bootstrapping, and entries in hiera.yaml referencing them are
generated.</p>
<h3 id="additional_config-parameter-format">additional_config Parameter Format</h3>
<p>Entries in the list of repositories are formatted as follows:</p>
<pre><code>&lt;repository url&gt;[#&lt;revision&gt;]::[[&lt;path&gt;][:&lt;path&gt; ...]]
</code></pre>

<p>An entry consists of the following components:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>repository url</code></td>
<td>The Repository's  URL (mandatory).</td>
</tr>
<tr>
<td><code>revision</code></td>
<td>A revision (branch or commit ID) of the repository to check out (optional).</td>
</tr>
<tr>
<td><code>path</code></td>
<td>A path referencing a YAML file (the .yaml extension may be omitted), relative to the repository's root directory. Each of these paths will result in an entry in hiera.yaml. There may be multiple paths, separated by colons as in a <code>$PATH</code> variable. Paths my include shell wildcards (<code>*</code>, <code>?</code>, etc.) which will be expanded.</td>
</tr>
</tbody>
</table>
<h3 id="additional_config-example">additional_config Example</h3>
<p>This is what the contents of an <code>additional_config</code> parameter might look like: </p>
<pre><code>'https://example.com/my-additional-config.git::ssh/mykeys.yaml \
git@gitlab.example.com:my-team/my-config.git#devel::config/ssh/keys:apache/*'
</code></pre>

<p>This will trigger the following actions:</p>
<ul>
<li>Clone <code>https://example.com/my-additional-config.git</code> and symlink it to <code>/etc/puppet/hieradata/my-additional-config</code>.</li>
<li>Add <code>my-additional-config/ssh/mykeys</code> to Hiera's hierarchy.</li>
<li>Clone <code>git@gitlab.example.com:my-team/my-config.git</code>, checkout revision <code>devel</code> and symlink it to <code>/etc/puppet/hieradata/my-team</code>.</li>
<li>Add <code>my-team/ssh/keys</code>, and all contents of the <code>apache/</code> subdirectory to Hiera's hierarchy.</li>
</ul>
<h3 id="entry-position-in-hierayaml">Entry Position in hiera.yaml</h3>
<p>Hierarchy entries resulting from the <code>additional_config</code> parameter will appear
before entries from the <a href="../glossary/#project-config">project-config</a> repository.</p>
<p>Repositories will appear in the order their repository specifications appear in
<code>additional_config</code>.</p>
<p>Paths associated with a given repository will appear in the order they were
given in the repository's <code>additional_config</code> entry.</p>
<h2 id="cloud-init-user-data-script-and-metadata-parameters">cloud-init: User Data Script and Metadata Parameters</h2>
<p>Last, but not least, <a href="https://cloudinit.readthedocs.org/">cloud-init</a>, is the glue that binds the
other two configuration sources together. It is used in two ways: to inject a
user-data script into an instance and to pass so-called 'metadata', a set of
key-value parameters. The user-data script kicks off the bootstrapping process,
the metadata parameters influence its behaviour.</p>
<h3 id="cloud-init-user-data-script">cloud-init user-data script</h3>
<p>The user-data script generated by <a href="http://autostrap.github.io/heat-resources/#_as_autostrap">AS::autostrap</a> 
is parametrized by its parent heat template and passed to to all servers in a
service stack. Through this mechanism the servers receive their deploy keys
and their configuration repositories' URLs. This script is usually generated
once per service stack and passed to all machines unchanged.</p>
<p>One notable parameter to this script is
<a href="http://autostrap.github.io/heat-resources/#_override_yaml">override_yaml</a>. It contains
the contents of <code>override.yaml</code>, a file that will appear at the very top of
the machine's <code>hiera.yaml</code> and override all other configuration. This
mechanism is very useful for deploying development stacks based off one or
more development branches, or for any other temporary configuration you don't
want to commit to your project-config repository.</p>
<p>If you require additional high-level entries, for instance to pull in passwords
automatically generated by your bootstraping scripts, you can use the
<a href="http://autostrap.github.io/heat-resources/#_extra_overrides">extra_overrides</a> parameter to
add arbitrary hierarchy entries between <code>override.yaml</code> and
<a href="../config/#additional">additional-config</a>/<a href="../config/#project">project-config</a>.</p>
<h2 id="cloud-init-metadata-parameters">cloud-init metadata parameters</h2>
<p>Various <code>cloud-init</code> metadata paremeters influence the behaviour of puppet,
pass information (such as its floating IP address), or control the
<a href="../glossary/#topic">topics</a> deployed on a given machine. Metadata parameters can
vary on a per-machine basis (e.g. typically only one machine will be assigned
the <code>puppet-master</code> topic while all others are assigned the <code>puppet-agent</code>
topic).</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../workflow/" class="btn btn-neutral float-right" title="Deployment Workflow"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../lifecycle/" class="btn btn-neutral" title="Life of a Stack"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../lifecycle/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../workflow/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
